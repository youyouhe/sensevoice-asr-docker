# å¤šå®ä¾‹ASRç³»ç»Ÿ

è¿™ä¸ªé¡¹ç›®å°†å•å®ä¾‹çš„SenseVoice ASRç³»ç»Ÿæ”¹é€ ä¸ºæ”¯æŒ5ä¸ªå¹¶å‘å®ä¾‹çš„å¤šå®ä¾‹ç³»ç»Ÿï¼Œæ˜¾è‘—æå‡ååé‡å’Œå¹¶å‘æ€§èƒ½ã€‚

## ç³»ç»Ÿç‰¹æ€§

### ğŸš€ æ ¸å¿ƒç‰¹æ€§
- **5ä¸ªå¹¶å‘æ¨¡å‹å®ä¾‹**: åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œå¤§å¹…æå‡ååé‡
- **æ™ºèƒ½è´Ÿè½½å‡è¡¡**: è‡ªåŠ¨åˆ†é…è¯·æ±‚åˆ°ç©ºé—²å®ä¾‹ï¼Œé¿å…å•ç‚¹è¿‡è½½
- **å¼‚æ­¥å¹¶å‘å¤„ç†**: æ”¯æŒçœŸæ­£çš„å¹¶è¡Œæ¨ç†ï¼Œéé˜»å¡å¼è¯·æ±‚å¤„ç†
- **å®æ—¶å¥åº·ç›‘æ§**: è‡ªåŠ¨ç›‘æ§å®ä¾‹çŠ¶æ€ï¼Œæä¾›è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
- **è‡ªåŠ¨é”™è¯¯æ¢å¤**: å†…ç½®é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§
- **èµ„æºä¼˜åŒ–**: æ™ºèƒ½GPUå†…å­˜ç®¡ç†å’Œè®¾å¤‡åˆ†é…

### ğŸ“Š æ€§èƒ½æå‡
- **ååé‡**: é¢„æœŸæå‡3-5å€ï¼ˆå–å†³äºç¡¬ä»¶é…ç½®ï¼‰
- **å¹¶å‘èƒ½åŠ›**: æ”¯æŒ10+å¹¶å‘è¯·æ±‚åŒæ—¶å¤„ç†
- **å“åº”æ—¶é—´**: å¹³å‡å“åº”æ—¶é—´ä¿æŒç¨³å®šï¼ŒP95å»¶è¿Ÿæ˜¾è‘—é™ä½
- **èµ„æºåˆ©ç”¨ç‡**: GPUåˆ©ç”¨ç‡ä»~20%æå‡åˆ°~80%

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client App   â”‚    â”‚   Client App   â”‚    â”‚   Client App   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Load Balancer â”‚
                    â”‚  (Round Robin) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Instance 1  â”‚      â”‚ Instance 2  â”‚      â”‚ Instance 3  â”‚
    â”‚  GPU:0      â”‚      â”‚  GPU:1      â”‚      â”‚  GPU:0      â”‚
    â”‚  Status:Idleâ”‚      â”‚  Status:Busyâ”‚      â”‚  Status:Idleâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Instance 4  â”‚      â”‚ Instance 5  â”‚      â”‚             â”‚
    â”‚  GPU:1      â”‚      â”‚  GPU:0      â”‚      â”‚             â”‚
    â”‚  Status:Idleâ”‚      â”‚  Status:Busyâ”‚      â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–‡ä»¶ç»“æ„

```
sensevoice-asr-docker/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ model_pool.py              # å¤šå®ä¾‹æ¨¡å‹æ± ç®¡ç†å™¨
â”‚   â”œâ”€â”€ api_multi_instance.py      # å¤šå®ä¾‹APIæœåŠ¡å™¨
â”‚   â”œâ”€â”€ monitoring.py              # ç³»ç»Ÿç›‘æ§è„šæœ¬
â”‚   â”œâ”€â”€ performance_test.py        # æ€§èƒ½æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ tmp/                       # ä¸´æ—¶æ–‡ä»¶ç›®å½•
â”œâ”€â”€ multi_instance_manager.sh      # ç³»ç»Ÿç®¡ç†è„šæœ¬
â”œâ”€â”€ MULTI_INSTANCE_TODOLIST.md     # ä»»åŠ¡è·Ÿè¸ªæ–‡æ¡£
â”œâ”€â”€ monitoring_logs/               # ç›‘æ§æ—¥å¿—ç›®å½•
â””â”€â”€ README.md                      # æœ¬æ–‡æ¡£
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š
- Python 3.8+
- CUDA 11.0+ (å¦‚æœä½¿ç”¨GPU)
- è‡³å°‘8GBæ˜¾å­˜ (æ¨è16GB+)
- è¶³å¤Ÿçš„ç³»ç»Ÿå†…å­˜

### 2. å®‰è£…ä¾èµ–

```bash
# å®‰è£…åŸºç¡€ä¾èµ–
pip install torch torchaudio fastapi uvicorn aiohttp

# å®‰è£…ç³»ç»Ÿç›‘æ§ä¾èµ–
pip install psutil GPUtil

# å®‰è£…FunASR
pip install funasr

# å®‰è£…éŸ³é¢‘å¤„ç†ä¾èµ–
pip install pydub requests
```

### 3. å‡†å¤‡æµ‹è¯•æ–‡ä»¶

```bash
# å‡†å¤‡æµ‹è¯•éŸ³é¢‘æ–‡ä»¶
# æ”¯æŒæ ¼å¼: wav, mp3, flac, m4a
cp your_test_audio.wav 7.wav
```

### 4. å¯åŠ¨ç³»ç»Ÿ

```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x multi_instance_manager.sh

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./multi_instance_manager.sh start
```

### 5. éªŒè¯ç³»ç»ŸçŠ¶æ€

```bash
# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
./multi_instance_manager.sh status

# æ£€æŸ¥APIå¥åº·çŠ¶æ€
curl http://localhost:5002/health

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:5002/stats
```

## ä½¿ç”¨æ–¹æ³•

### APIæ¥å£

#### 1. æ ‡å‡†ASRæ¥å£ (å¸¦VADåˆ†æ®µ)

```bash
curl -X POST "http://localhost:5002/asr" \
  -F "file=@your_audio.wav" \
  -F "lang=zh"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": "1\n00:00:00,000 --> 00:00:03,500\nä½ å¥½ä¸–ç•Œ\n\n2\n00:00:03,500 --> 00:00:06,000\nè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•",
  "stats": {
    "total_segments": 2,
    "successful_segments": 2,
    "failed_segments": 0,
    "success_rate": 1.0
  }
}
```

#### 2. ç®€å•ASRæ¥å£ (æ— VADåˆ†æ®µ)

```bash
curl -X POST "http://localhost:5002/asr_simple" \
  -F "file=@your_audio.wav" \
  -F "lang=zh"
```

#### 3. å¥åº·æ£€æŸ¥

```bash
curl http://localhost:5002/health
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "health_ratio": 1.0,
  "total_instances": 5,
  "healthy_instances": 5,
  "unhealthy_instances": 0,
  "health_details": [...]
}
```

#### 4. ç»Ÿè®¡ä¿¡æ¯

```bash
curl http://localhost:5002/stats
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "model_pool_stats": {
    "total_instances": 5,
    "total_requests": 100,
    "successful_requests": 98,
    "failed_requests": 2,
    "success_rate": 0.98,
    "instances": [...]
  },
  "pool_status": {
    "pool_size": 5,
    "status_distribution": {
      "idle": 3,
      "busy": 2,
      "loading": 0,
      "error": 0
    },
    "available_instances": 3
  }
}
```

### æ”¯æŒçš„è¯­è¨€

- `zh`: ä¸­æ–‡
- `en`: è‹±è¯­
- `ja`: æ—¥è¯­
- `ko`: éŸ©è¯­
- `yue`: ç²¤è¯­

## æ€§èƒ½æµ‹è¯•

### è¿è¡Œæ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œé»˜è®¤æ€§èƒ½æµ‹è¯•
./multi_instance_manager.sh test

# æˆ–è€…ç›´æ¥è¿è¡Œæµ‹è¯•è„šæœ¬
python3 src/performance_test.py
```

### æ€§èƒ½æµ‹è¯•é…ç½®

åœ¨ `performance_test.py` ä¸­å¯ä»¥ä¿®æ”¹æµ‹è¯•é…ç½®ï¼š

```python
config = TestConfig(
    api_url="http://localhost:5002",
    test_file="7.wav",
    language="zh",
    concurrent_users=10,      # å¹¶å‘ç”¨æˆ·æ•°
    requests_per_user=5,      # æ¯ä¸ªç”¨æˆ·çš„è¯·æ±‚æ•°
    delay_between_requests=0.1, # è¯·æ±‚é—´å»¶è¿Ÿ
    timeout=60                # è¶…æ—¶æ—¶é—´
)
```

### æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•å®Œæˆåä¼šç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼š

- `performance_test_report_YYYYMMDD_HHMMSS.json`: JSONæ ¼å¼çš„è¯¦ç»†æ•°æ®
- `performance_test_report_YYYYMMDD_HHMMSS_readable.txt`: å¯è¯»çš„æ–‡æœ¬æŠ¥å‘Š

æŠ¥å‘ŠåŒ…å«ï¼š
- ååé‡å’ŒæˆåŠŸç‡
- å“åº”æ—¶é—´ç»Ÿè®¡ (å¹³å‡ã€P90ã€P95ã€P99)
- èµ„æºä½¿ç”¨æƒ…å†µ (CPUã€å†…å­˜ã€GPU)
- é”™è¯¯åˆ†æå’Œå»ºè®®

## ç›‘æ§ç³»ç»Ÿ

### å¯åŠ¨ç›‘æ§

ç›‘æ§ç³»ç»Ÿä¼šéšç€ä¸»ç³»ç»Ÿè‡ªåŠ¨å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å¯åŠ¨ï¼š

```bash
# å¯åŠ¨ç›‘æ§ç³»ç»Ÿ
python3 src/monitoring.py
```

### ç›‘æ§åŠŸèƒ½

- **å®æ—¶å¥åº·æ£€æŸ¥**: æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡å®ä¾‹çŠ¶æ€
- **æ€§èƒ½æŒ‡æ ‡ç›‘æ§**: è¯·æ±‚å¤„ç†æ—¶é—´ã€æˆåŠŸç‡ç­‰
- **ç³»ç»Ÿèµ„æºç›‘æ§**: CPUã€å†…å­˜ã€GPUä½¿ç”¨ç‡
- **æ™ºèƒ½å‘Šè­¦**: åŸºäºé˜ˆå€¼çš„è‡ªåŠ¨å‘Šè­¦
- **å†å²æ•°æ®åˆ†æ**: ä¿å­˜ç›‘æ§æ•°æ®ç”¨äºåˆ†æ

### ç›‘æ§æ•°æ®

ç›‘æ§æ•°æ®ä¿å­˜åœ¨ `monitoring_logs/` ç›®å½•ä¸‹ï¼š
- `monitoring_YYYYMMDD_HHMMSS.json`: ç›‘æ§æ•°æ®å¿«ç…§
- å®æ—¶æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°å’Œ `monitoring.log`

## ç³»ç»Ÿç®¡ç†

### ç®¡ç†è„šæœ¬ä½¿ç”¨

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./multi_instance_manager.sh start

# åœæ­¢æ‰€æœ‰æœåŠ¡
./multi_instance_manager.sh stop

# é‡å¯æœåŠ¡
./multi_instance_manager.sh restart

# æŸ¥çœ‹çŠ¶æ€
./multi_instance_manager.sh status

# è¿è¡Œæ€§èƒ½æµ‹è¯•
./multi_instance_manager.sh test

# æŸ¥çœ‹å¸®åŠ©
./multi_instance_manager.sh help
```

### æ—¥å¿—æ–‡ä»¶

- `server.log`: APIæœåŠ¡å™¨æ—¥å¿—
- `monitoring.log`: ç›‘æ§ç³»ç»Ÿæ—¥å¿—
- `monitoring_logs/`: è¯¦ç»†ç›‘æ§æ•°æ®
- `performance_test_report_*.json`: æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

### è¿›ç¨‹ç®¡ç†

```bash
# æŸ¥çœ‹æœåŠ¡å™¨è¿›ç¨‹
cat server.pid
ps -p $(cat server.pid)

# æŸ¥çœ‹ç›‘æ§è¿›ç¨‹
cat monitoring.pid
ps -p $(cat monitoring.pid)

# æ‰‹åŠ¨åœæ­¢è¿›ç¨‹
kill $(cat server.pid)
kill $(cat monitoring.pid)
```

## é…ç½®ä¼˜åŒ–

### å®ä¾‹æ•°é‡è°ƒæ•´

åœ¨ `api_multi_instance.py` ä¸­ä¿®æ”¹ï¼š

```python
# å¤šå®ä¾‹é…ç½®
NUM_INSTANCES = 5  # æ ¹æ®GPUå†…å­˜è°ƒæ•´

# å¦‚æœæœ‰å¤šä¸ªGPUï¼Œå¯ä»¥åˆ†é…æ›´å¤šå®ä¾‹
# NUM_INSTANCES = 8  # éœ€è¦24GB+æ˜¾å­˜
```

### èµ„æºåˆ†é…ç­–ç•¥

ç³»ç»Ÿè‡ªåŠ¨è¿›è¡ŒGPUèµ„æºåˆ†é…ï¼š
- å•GPU: è½®è¯¢åˆ†é…å®ä¾‹
- å¤šGPU: å‡è¡¡åˆ†é…åˆ°ä¸åŒGPU

### è¶…æ—¶å’Œé‡è¯•é…ç½®

åœ¨ `model_pool.py` ä¸­ä¿®æ”¹ï¼š

```python
# è¶…æ—¶é…ç½®
self.max_retries = 3
self.request_timeout = 30
self.load_timeout = 600
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ¨¡å‹åŠ è½½å¤±è´¥
```
Error: Failed to load model instances
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿å¯ä»¥ä¸‹è½½æ¨¡å‹
- æ£€æŸ¥CUDAç‰ˆæœ¬å…¼å®¹æ€§
- ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´

#### 2. GPUå†…å­˜ä¸è¶³
```
Error: CUDA out of memory
```
**è§£å†³æ–¹æ¡ˆ**:
- å‡å°‘å®ä¾‹æ•°é‡ `NUM_INSTANCES`
- ä½¿ç”¨æ›´å°çš„æ¨¡å‹
- å¢åŠ GPUæ˜¾å­˜æˆ–ä½¿ç”¨å¤šä¸ªGPU

#### 3. ç«¯å£è¢«å ç”¨
```
Error: Port 5002 is already in use
```
**è§£å†³æ–¹æ¡ˆ**:
- åœæ­¢å ç”¨ç«¯å£çš„ç¨‹åº
- ä¿®æ”¹ `PORT` é…ç½®
- ä½¿ç”¨ `lsof -i :5002` æŸ¥çœ‹å ç”¨è¿›ç¨‹

#### 4. APIå“åº”è¶…æ—¶
```
Error: Request timeout
```
**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ  `timeout` é…ç½®
- æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
- å‡å°‘å¹¶å‘è¯·æ±‚æ•°é‡

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼š

```bash
# å¯åŠ¨æœåŠ¡å™¨æ—¶å¯ç”¨è¯¦ç»†æ—¥å¿—
python3 src/api_multi_instance.py --log-level debug

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
tail -f server.log
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç¡¬ä»¶ä¼˜åŒ–**:
   - ä½¿ç”¨æ›´å¿«çš„GPU (RTX 3090/4090)
   - å¢åŠ ç³»ç»Ÿå†…å­˜
   - ä½¿ç”¨NVMe SSD

2. **è½¯ä»¶ä¼˜åŒ–**:
   - å‡çº§åˆ°æœ€æ–°CUDAç‰ˆæœ¬
   - ä½¿ç”¨ä¼˜åŒ–çš„PyTorchç‰ˆæœ¬
   - å¯ç”¨CUDAå›¾ä¼˜åŒ–

3. **é…ç½®ä¼˜åŒ–**:
   - æ ¹æ®è´Ÿè½½è°ƒæ•´å®ä¾‹æ•°é‡
   - ä¼˜åŒ–è¯·æ±‚æ‰¹å¤„ç†å¤§å°
   - è°ƒæ•´è¶…æ—¶è®¾ç½®

## æŠ€æœ¯ç»†èŠ‚

### æ¨¡å‹æ± ç®¡ç†

`ModelPool` ç±»è´Ÿè´£ï¼š
- æ¨¡å‹å®ä¾‹çš„åˆ›å»ºå’Œç®¡ç†
- è´Ÿè½½å‡è¡¡ç­–ç•¥ (è½®è¯¢)
- å¥åº·çŠ¶æ€ç›‘æ§
- é”™è¯¯æ¢å¤æœºåˆ¶

### è¯·æ±‚å¤„ç†æµç¨‹

1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°APIæœåŠ¡å™¨
2. æœåŠ¡å™¨è·å–ç©ºé—²æ¨¡å‹å®ä¾‹
3. å°†è¯·æ±‚åˆ†é…åˆ°å®ä¾‹å¤„ç†
4. å¼‚æ­¥å¤„ç†VADåˆ†æ®µ
5. å¹¶å‘å¤„ç†éŸ³é¢‘ç‰‡æ®µ
6. æ±‡æ€»ç»“æœå¹¶è¿”å›

### å¹¶å‘æ§åˆ¶

- **å¼‚æ­¥I/O**: ä½¿ç”¨asyncioè¿›è¡Œéé˜»å¡I/Oæ“ä½œ
- **çº¿ç¨‹æ± **: CPUå¯†é›†å‹æ“ä½œä½¿ç”¨çº¿ç¨‹æ± 
- **èµ„æºé™åˆ¶**: é™åˆ¶æœ€å¤§å¹¶å‘è¯·æ±‚æ•°é‡

## è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ·Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªåŸæœ‰é¡¹ç›®çš„è®¸å¯è¯ã€‚

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚